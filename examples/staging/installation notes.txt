# SSH onto your server

# Install PeterSSLers

    source peter_sslers-venv/bin/activate
    git clone git@github.com:aptise/peter_sslers.git
    cd peter_sslers
    pip install -e .
    
You might prefer:

    pip install -e .[testing]

# Generate the Staging Example

    cd examples/staging
    python _cloudflare_a_records.py
    python _generate_openresty.py

    cd /var/www/sites
    sudo ln -s ~/peter_sslers/examples/staging/www com.aptise.opensource.testing.peter_sslers
    ls -alh com.aptise.opensource.testing.peter_sslers

    cd /etc/openresty
    sudo ln -s ~/peter_sslers/examples/staging/nginx_conf/com.aptise.opensource.testing.peter_sslers_ .

## Edit Nginx conf

    vi nginx.conf

### Add the following line

    include /etc/openresty/com.aptise.opensource.testing.peter_sslers/sites-available/*;

## test nginx

    sudo openresty -t

## restart nginx

    ps aux | grep openresty
    kill -HUP ##PID##
    
## check page

    https://peter-sslers.testing.opensource.aptise.com/
    https://peter-sslers.testing.opensource.aptise.com/

## initialize peter_sslers

    cd ~/peter_sslers
    mkdir _data_
    touch _data_/nginx_ca_bundle.pem

# copy and edit the conf

ensure there are no debug routes, etc on

    cp conf/example_development.ini conf/staging.ini
    vi conf/staging.ini
    
    initialize_peter_sslers_db conf/staging.ini

## create an account

List the accounts: none!

    ssl_manage conf/staging.ini acme-account list

List the CAs - we want STAGING

    ssl_manage conf/staging.ini acme-server list

Create an account with: LetsEncrypt Staging

acme_server_id = 4; letsencrypt staging

    ssl_manage conf/staging.ini acme-account new help=1
    ssl_manage conf/staging.ini acme-account new acme_server_id=4 account__order_default_private_key_cycle=single_use account__order_default_private_key_technology=RSA_2048 account__private_key_technology=RSA_2048 account__contact="peter_sslers@2xlp.com"

Create an account with: BuyPass Staging

acme_server_id = 6; buypass staging
    ssl_manage conf/staging.ini acme-account new help=1
    ssl_manage conf/staging.ini acme-account new acme_server_id=6 account__order_default_private_key_cycle=single_use account__order_default_private_key_technology=RSA_2048 account__private_key_technology=RSA_2048 account__contact="peter_sslers@2xlp.com"




The above shows a success message, but double-check and note the account_id

    ssl_manage conf/staging.ini acme-account list

Create the Enrollment factory, with acme_account_id__primary = 1; this will fail

    ssl_manage conf/staging.ini enrollment-factory list
    ssl_manage conf/staging.ini enrollment-factory new help=1
    ssl_manage conf/staging.ini enrollment-factory new acme_account_id__primary=1 domain_template_dns01="dns-01.{DOMAIN}" domain_template_http01="http-01.{DOMAIN}" is_export_filesystem=on label_template="chall_prefix-{DOMAIN}" name="Example Configuration" private_key_cycle__primary=account_weekly private_key_technology__primary=EC_P256

there should be an error like this:

    #  'domain_template_dns01': 'The global acme-dns server is not configured.'}

# we need to set up acme-dns!

    ssl_manage conf/staging.ini acme-dns-server list
    ssl_manage conf/staging.ini acme-dns-server new help=1
    ssl_manage conf/staging.ini acme-dns-server new api_url="http://127.0.0.1:8011" domain="acme-dns.aptise.com"
    ssl_manage conf/staging.ini acme-dns-server list
    ssl_manage conf/staging.ini acme-dns-server check id=1

    ssl_manage conf/staging.ini enrollment-factory new acme_account_id__primary=1 domain_template_dns01="dns-01.{DOMAIN}" domain_template_http01="http-01.{DOMAIN}" is_export_filesystem=on label_template="chall_prefix-{DOMAIN}" name="Example Configuration" private_key_cycle__primary=account_weekly private_key_technology__primary=EC_P256
    ssl_manage conf/staging.ini enrollment-factory list

    ssl_manage conf/staging.ini renewal-configuration list
    ssl_manage conf/staging.ini renewal-configuration new-enrollment help=1

    ssl_manage conf/staging.ini renewal-configuration new-enrollment enrollment_factory_id=1 is_export_filesystem=enrollment_factory_default label="chall_prefix-{DOMAIN}" domain_name="a.peter-sslers.testing.opensource.aptise.com"
    ssl_manage conf/staging.ini renewal-configuration new-enrollment enrollment_factory_id=1 is_export_filesystem=enrollment_factory_default label="chall_prefix-{DOMAIN}" domain_name="b.peter-sslers.testing.opensource.aptise.com"
    ssl_manage conf/staging.ini renewal-configuration new-enrollment enrollment_factory_id=1 is_export_filesystem=enrollment_factory_default label="chall_prefix-{DOMAIN}" domain_name="c.peter-sslers.testing.opensource.aptise.com"
    ssl_manage conf/staging.ini renewal-configuration new-enrollment enrollment_factory_id=1 is_export_filesystem=enrollment_factory_default label="chall_prefix-{DOMAIN}" domain_name="d.peter-sslers.testing.opensource.aptise.com"

    acme_dns_audit conf/staging.ini format=json

    # export CLOUDFLARE_API_TOKEN="{YOUR_API_TOKEN}"

    python tools/acme_dns_audit-process_cloudflare.py acme_dns_audit-accounts.json






REMOVE
enable_acme_flow
